<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Community — Landlord Fortress</title>
    <link rel="stylesheet" href="https://use.typekit.net/kbs3miz.css" />
    <style>
      :root {
        --bg: #f7f9fc;
        --surface: #fff;
        --rule: #e8eef4;
        --text: #1f2937;
        --muted: #6b7280;
        --accent: #22c1a1;
        --radius: 12px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family:
          "proxima-nova",
          system-ui,
          -apple-system,
          Arial;
      }

      /* ---------- Header / Nav ---------- */
      header {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--rule);
      }
      header .container {
        max-width: 1200px;
      } /* wider header than page body */
      .nav {
        display: flex;
        align-items: center;
        gap: 32px;
        padding: 12px 20px;
      }
      .brand {
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.95rem;
        color: var(--text);
      }
      .menu {
        display: flex;
        gap: 28px;
        align-items: center;
      }
      .menu a {
        text-decoration: none;
        color: #4b5563;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-weight: 300;
        font-size: 0.8rem;
        transition: color 0.18s;
      }
      .menu a:hover,
      .menu a.active {
        color: var(--accent);
      }
      .auth-actions {
        margin-left: auto;
        display: flex;
        gap: 10px;
      }

      /* ---------- Page layout ---------- */
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        margin: 10px 0 4px;
        font-weight: 800;
      }
      .sub {
        color: var(--muted);
        margin: 0 0 16px;
      }
      .bar {
        display: flex;
        gap: 8px;
        margin: 10px 0 16px;
      }
      .btn {
        appearance: none;
        border: 1px solid #d5dde7;
        background: #fff;
        padding: 10px 14px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.primary {
        background: var(--accent);
        border-color: transparent;
        color: #062a26;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--rule);
        border-radius: var(--radius);
        padding: 14px;
      }
      .list {
        display: grid;
        gap: 10px;
        margin: 16px 0;
      }
      .item {
        background: #fff;
        border: 1px solid var(--rule);
        border-radius: 10px;
        padding: 12px;
      }
      .meta {
        color: var(--muted);
        font-size: 0.9rem;
      }
      .link {
        color: #0f766e;
        text-decoration: none;
      }
      .link:hover {
        text-decoration: underline;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d5dde7;
        border-radius: 10px;
      }
      label {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .error {
        color: #b91c1c;
        font-size: 0.9rem;
      }
      .chip {
        appearance: none;
        border: 1px solid var(--rule);
        background: #fff;
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .chip.active {
        background: #ebfbf7;
        border-color: #b9f0e4;
        color: #0f766e;
      }

      /* ---------- Auth modal ---------- */
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        padding: 16px;
        z-index: 9999;
      }
      .modal.open {
        display: flex;
      }
      .sheet {
        background: #fff;
        border: 1px solid var(--rule);
        border-radius: 20px;
        padding: 18px;
        max-width: 520px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      .sheet h3 {
        margin: 0 0 6px;
        font-size: 1.6rem;
        font-weight: 800;
      }
      .sheet .sub {
        margin: 0 0 14px;
      }
      .sheet .actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
      }
      .sheet .fine {
        margin-top: 10px;
        font-size: 0.95rem;
        color: var(--muted);
      }
      .sheet .fine a {
        color: #0f766e;
        text-decoration: none;
      }
      .sheet .fine a:hover {
        text-decoration: underline;
      }
      .input-row {
        display: grid;
        gap: 6px;
        margin: 8px 0;
      }
    </style>
  </head>
  <body>
    <!-- NAV (consistent across pages) -->
    <header>
      <div class="container nav">
        <div class="brand">A.I. Unlimited Publishing House LLC</div>

        <nav class="menu">
          <a href="index.html">Home</a>
          <a class="active" href="community.html">Community</a>
          <a href="books.html">Books</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
        </nav>

        <!-- auth actions (top-right) -->
        <div class="auth-actions">
          <button class="btn" id="signInBtn">Sign in</button>
          <button class="btn" id="signOutBtn" style="display: none">
            Sign out
          </button>
        </div>
      </div>
    </header>

    <div class="container">
      <h1>Community</h1>
      <p class="sub">
        Discuss books, laws, and landlord strategy. Be respectful.
      </p>

      <!-- Page-only actions -->
      <div class="bar" style="justify-content: flex-end">
        <button class="btn primary" id="newPostBtn">New Post</button>
      </div>

      <div class="bar" id="tagsBar">
        <button class="chip active" data-tag="All">All</button>
        <button class="chip" data-tag="Law & Ethics">Law & Ethics</button>
        <button class="chip" data-tag="Evictions">Evictions</button>
        <button class="chip" data-tag="Rent Control">Rent Control</button>
      </div>

      <div id="error" class="error"></div>

      <div id="newPost" class="card" style="display: none">
        <div class="row" style="justify-content: space-between">
          <strong>Create a new post</strong>
          <button class="btn" id="closePost">Close</button>
        </div>
        <div style="display: grid; gap: 8px; margin-top: 8px">
          <label
            >Title
            <input
              id="title"
              maxlength="200"
              placeholder="Clear, specific title"
            />
          </label>
          <label
            >Body (optional)
            <textarea
              id="body"
              rows="5"
              placeholder="Write your post..."
            ></textarea>
          </label>
          <label
            >Tags (comma separated)
            <input id="tags" placeholder="Law & Ethics, Evictions" />
          </label>
          <div class="row">
            <button class="btn primary" id="publish">Publish</button>
            <div id="postError" class="error"></div>
          </div>
        </div>
      </div>

      <div class="list" id="threads"></div>
    </div>

    <!-- AUTH MODAL (Sign in / Create account) -->
    <div class="modal" id="authModal">
      <div
        class="sheet"
        role="dialog"
        aria-modal="true"
        aria-labelledby="authTitle"
      >
        <h3 id="authTitle">Sign in</h3>
        <p class="sub" id="authSub">Accounts are required to post or reply.</p>

        <div class="input-row">
          <label
            >Email
            <input
              id="authEmail"
              type="email"
              placeholder="you@example.com"
              autocomplete="username"
            />
          </label>
        </div>
        <div class="input-row">
          <label
            >Password
            <input
              id="authPassword"
              type="password"
              placeholder="••••••••"
              autocomplete="current-password"
            />
          </label>
        </div>
        <div class="input-row" id="authUsernameRow" style="display: none">
          <label
            >Username
            <input id="authUsername" placeholder="your-handle" />
          </label>
        </div>

        <div class="actions">
          <button class="btn primary" id="authPrimary">Sign in</button>
          <button class="btn" id="authCancel">Cancel</button>
          <span id="authErr" class="error"></span>
        </div>

        <p class="fine">
          <span id="authSwitchLine">No account?</span>
          <a href="#" id="authSwitch">Create one</a>
        </p>
      </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // === CONFIG ===
      const SUPABASE_URL = "https://wmfqzxlzaipqdhohvulp.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZnF6eGx6YWlwcWRob2h2dWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzg1NDIsImV4cCI6MjA3MTc1NDU0Mn0.l_1y79L33k5Lm5oNKG8aT6emNTF79udKXUTQLqwf7Fo";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // === DOM ===
      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");
      const newPostBtn = document.getElementById("newPostBtn");
      const newPost = document.getElementById("newPost");
      const closePost = document.getElementById("closePost");
      const title = document.getElementById("title");
      const body = document.getElementById("body");
      const tags = document.getElementById("tags");
      const publish = document.getElementById("publish");
      const postError = document.getElementById("postError");
      const errorBox = document.getElementById("error");
      const threadsEl = document.getElementById("threads");
      const chips = Array.from(document.querySelectorAll("#tagsBar .chip"));

      // Auth modal elements
      const authModal = document.getElementById("authModal");
      const authTitle = document.getElementById("authTitle");
      const authPrimary = document.getElementById("authPrimary");
      const authCancel = document.getElementById("authCancel");
      const authErr = document.getElementById("authErr");
      const authSwitch = document.getElementById("authSwitch");
      const authSwitchLine = document.getElementById("authSwitchLine");
      const authEmail = document.getElementById("authEmail");
      const authPassword = document.getElementById("authPassword");
      const authUsernameRow = document.getElementById("authUsernameRow");
      const authUsername = document.getElementById("authUsername");

      // === STATE ===
      let currentUser = null;
      let currentTag = "All";
      let authMode = "signin"; // 'signin' | 'signup'
      let working = false;

      const esc = (s) =>
        (s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[c]
        );
      const timeAgo = (iso) => {
        const s = Math.floor((Date.now() - new Date(iso)) / 1000);
        for (const [label, n] of [
          ["year", 31536000],
          ["month", 2592000],
          ["day", 86400],
          ["hour", 3600],
          ["minute", 60],
        ]) {
          const v = Math.floor(s / n);
          if (v >= 1) return `${v} ${label}${v > 1 ? "s" : ""} ago`;
        }
        return "just now";
      };
      const toggle = (el, on) => (el.style.display = on ? "" : "none");
      const showError = (msg) => (errorBox.textContent = msg || "");

      function setAuthUI(signedIn) {
        toggle(signInBtn, !signedIn);
        toggle(signOutBtn, signedIn);
      }
      function openAuth(mode = "signin") {
        setAuthMode(mode);
        authErr.textContent = "";
        authEmail.value = "";
        authPassword.value = "";
        authUsername.value = "";
        authModal.classList.add("open");
        setTimeout(() => authEmail.focus(), 0);
      }
      function closeAuth() {
        authModal.classList.remove("open");
      }
      function setAuthMode(next) {
        authMode = next;
        if (next === "signin") {
          authTitle.textContent = "Sign in";
          authPrimary.textContent = "Sign in";
          authSwitchLine.textContent = "No account?";
          authSwitch.textContent = "Create one";
          toggle(authUsernameRow, false);
        } else {
          authTitle.textContent = "Create account";
          authPrimary.textContent = "Create account";
          authSwitchLine.textContent = "Already have an account?";
          authSwitch.textContent = "Sign in";
          toggle(authUsernameRow, true);
        }
      }

      async function ensureProfile() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) return null;
        const { data: p } = await supabase
          .from("profiles")
          .select("id")
          .eq("id", user.id)
          .maybeSingle();
        if (!p) {
          const username =
            authUsername.value?.trim() || `user_${user.id.slice(0, 8)}`;
          await supabase.from("profiles").insert({ id: user.id, username });
        }
        return user;
      }

      async function loadThreads() {
        showError("");
        threadsEl.innerHTML = "Loading…";
        try {
          let q = supabase
            .from("threads_with_score")
            .select("*")
            .order("created_at", { ascending: false })
            .limit(50);
          if (currentTag !== "All") q = q.contains("tags", [currentTag]); // tags must be text[]
          const { data, error } = await q;
          if (error) throw error;

          if (!data || !data.length) {
            threadsEl.innerHTML =
              '<p class="sub">No posts yet. Be the first!</p>';
            return;
          }
          threadsEl.innerHTML = "";
          for (const t of data) {
            const el = document.createElement("div");
            el.className = "item";
            const tagsHtml = (t.tags || [])
              .map(
                (x) =>
                  `<span class="meta" style="margin-right:6px">#${esc(x)}</span>`
              )
              .join("");
            el.innerHTML = `
              <div class="row" style="justify-content:space-between">
                <strong>${esc(t.title)}</strong>
                <span class="meta">${t.comment_count} comments · ${timeAgo(t.created_at)}</span>
              </div>
              ${t.body ? `<div style="margin-top:6px">${esc(t.body)}</div>` : ""}
              <div class="row" style="margin-top:8px;justify-content:space-between">
                <div>${tagsHtml}</div>
                <a class="link" href="thread.html?id=${encodeURIComponent(t.id)}">Open →</a>
              </div>`;
            threadsEl.appendChild(el);
          }
        } catch (e) {
          threadsEl.innerHTML = "";
          showError(e.message || "Failed to load threads.");
        }
      }

      // ----- AUTH EVENTS
      signInBtn.addEventListener("click", () => openAuth("signin"));
      signOutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut({ scope: "global" });
        setAuthUI(false);
        await loadThreads();
      });
      authCancel.addEventListener("click", closeAuth);
      authSwitch.addEventListener("click", (e) => {
        e.preventDefault();
        setAuthMode(authMode === "signin" ? "signup" : "signin");
      });
      [authEmail, authPassword, authUsername].forEach((i) =>
        i.addEventListener("keydown", (e) => {
          if (e.key === "Enter") authPrimary.click();
        })
      );

      authPrimary.addEventListener("click", async () => {
        if (working) return;
        working = true;
        authErr.textContent = "";
        try {
          const email = authEmail.value.trim();
          const password = authPassword.value;
          if (!email || !password) {
            authErr.textContent = "Email and password required.";
            return;
          }

          if (authMode === "signin") {
            const { error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });
            if (error) throw error;
            await ensureProfile();
            setAuthUI(true);
            closeAuth();
            await loadThreads();
          } else {
            // Sign up (email confirmation may be required by your project settings)
            const { data, error } = await supabase.auth.signUp({
              email,
              password,
            });
            if (error) throw error;
            if (data.session) {
              await ensureProfile();
              setAuthUI(true);
              closeAuth();
              await loadThreads();
            } else {
              // No session until the user confirms email
              authErr.style.color = "#0f766e";
              authErr.textContent =
                "Check your email to confirm, then return to sign in.";
            }
          }
        } catch (e) {
          authErr.style.color = "#b91c1c";
          authErr.textContent = e.message || "Authentication failed.";
        } finally {
          working = false;
        }
      });

      // ----- NEW POST
      newPostBtn.addEventListener("click", async () => {
        postError.textContent = "";
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          openAuth("signin");
          return;
        }
        await ensureProfile();
        toggle(newPost, true);
      });
      closePost.addEventListener("click", () => toggle(newPost, false));

      publish.addEventListener("click", async () => {
        postError.textContent = "";
        const t = title.value.trim();
        const b = body.value.trim() || null;
        const tagList = tags.value
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        if (!t) {
          postError.textContent = "Title is required.";
          return;
        }
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          postError.textContent = "Please sign in.";
          return;
        }
        try {
          await ensureProfile();
          const { error } = await supabase
            .from("threads")
            .insert({ title: t, body: b, tags: tagList, author_id: user.id });
          if (error) throw error;
          title.value = "";
          body.value = "";
          tags.value = "";
          toggle(newPost, false);
          await loadThreads();
        } catch (e) {
          postError.textContent = e.message || "Could not publish.";
        }
      });

      // ----- TAG FILTER
      chips.forEach((ch) =>
        ch.addEventListener("click", async () => {
          chips.forEach((c) => c.classList.remove("active"));
          ch.classList.add("active");
          currentTag = ch.dataset.tag;
          await loadThreads();
        })
      );

      // ----- INIT
      (async function init() {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        currentUser = session?.user || null;
        setAuthUI(!!currentUser);
        if (currentUser) await ensureProfile();
        await loadThreads();
      })();
    </script>
  </body>
</html>
