<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Community — A.I. Unlimited Publishing House LLC</title>

    <!-- Proxima Nova -->
    <link rel="stylesheet" href="https://use.typekit.net/kbs3miz.css" />

    <style>
      :root {
        --bg: #f7f9fc;
        --surface: #fff;
        --panel: #fff;
        --text: #1f2937;
        --muted: #6b7280;
        --rule: #e8eef4;
        --accent: #22c1a1;
        --accent-2: #ffd28f;
        --radius: 14px;
        --container: 1200px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family:
          "proxima-nova", "Helvetica Neue", Helvetica, Arial, sans-serif;
        line-height: 1.5;
      }
      .container {
        width: min(100%, var(--container));
        margin: 0 auto;
        padding: 0 24px;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(8px);
      }
      .nav {
        display: flex;
        align-items: center;
        gap: 28px;
        padding: 14px 0;
      }
      .brand {
        margin-right: auto;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.95rem;
        color: var(--text);
      }
      .menu {
        display: flex;
        gap: 24px;
        align-items: center;
      }
      .menu a {
        text-decoration: none;
        color: #4b5563;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-weight: 300;
        font-size: 0.8rem;
        transition: color 0.2s;
      }
      .menu a:hover,
      .menu a.active {
        color: var(--accent);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid #d5dde7;
        background: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      .btn.primary {
        background: var(--accent);
        color: #081214;
        border-color: transparent;
      }
      .btn.primary:hover {
        box-shadow: 0 8px 16px rgba(34, 193, 161, 0.25);
      }
      .btn.ghost {
        background: transparent;
      }
      .btn.sm {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      .avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #e5eef6;
      }

      .page-head {
        padding: 28px 0 8px;
      }
      .page-title {
        margin: 0 0 6px;
        font-size: clamp(1.6rem, 2.2vw + 1rem, 2.6rem);
        font-weight: 800;
        letter-spacing: -0.01em;
      }
      .page-sub {
        color: var(--muted);
        margin: 0;
      }

      .tabs {
        display: flex;
        gap: 18px;
        align-items: center;
        margin: 18px 0;
        border-bottom: 1px solid var(--rule);
      }
      .tab {
        padding: 10px 0;
        font-size: 0.82rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #64748b;
        text-decoration: none;
        border-bottom: 2px solid transparent;
      }
      .tab.active,
      .tab:hover {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .tools {
        margin-left: auto;
        display: flex;
        gap: 10px;
      }
      .tagbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 10px 0;
      }
      .chip {
        border: 1px solid var(--rule);
        background: #fff;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        color: #475569;
        cursor: pointer;
      }
      .chip.active {
        background: #ebfbf7;
        border-color: #b9f0e4;
        color: #0f766e;
      }

      .threads {
        display: grid;
        gap: 12px;
        margin: 18px 0 46px;
      }
      .thread {
        background: var(--surface);
        border: 1px solid var(--rule);
        border-radius: 12px;
        display: grid;
        grid-template-columns: 48px 1fr auto;
        gap: 16px;
        align-items: center;
        padding: 14px 14px 14px 0;
      }
      .vote {
        display: grid;
        place-items: center;
        color: #64748b;
        padding: 10px;
      }
      .vote .up {
        display: block;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 9px solid #cbd5e1;
        margin-bottom: 4px;
        cursor: pointer;
      }
      .vote .down {
        display: block;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 9px solid #cbd5e1;
        margin-top: 4px;
        cursor: pointer;
      }
      .vote .count {
        font-weight: 700;
        font-size: 0.9rem;
      }

      .thread-main {
        display: grid;
        gap: 4px;
        padding-right: 6px;
      }
      .thread-title {
        margin: 0;
        font-weight: 700;
      }
      .thread-meta {
        color: var(--muted);
        font-size: 0.9rem;
      }
      .thread-tags {
        display: flex;
        gap: 6px;
        margin-top: 4px;
      }
      .tt {
        font-size: 0.72rem;
        padding: 4px 8px;
        border: 1px solid var(--rule);
        border-radius: 999px;
        color: #64748b;
      }

      .thread-cta {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .link {
        color: #0f766e;
        text-decoration: none;
      }
      .link:hover {
        text-decoration: underline;
      }

      /* Modals */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .modal.open {
        display: flex;
      }
      .sheet {
        background: #fff;
        border: 1px solid var(--rule);
        border-radius: 14px;
        max-width: 480px;
        width: 100%;
        padding: 18px;
      }
      .sheet h3 {
        margin: 0 0 8px;
      }
      .sheet p {
        margin: 0 0 12px;
        color: var(--muted);
      }
      .field {
        display: grid;
        gap: 6px;
        margin: 8px 0;
      }
      .field input,
      .field textarea {
        padding: 12px 14px;
        border: 1px solid #d5dde7;
        border-radius: 10px;
      }
      .sheet .row {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="container nav">
        <div class="brand">A.I. Unlimited Publishing House LLC</div>
        <nav class="menu">
          <a href="index.html">Home</a>
          <a class="active" href="community.html">Community</a>
          <a href="books.html">Books</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
        </nav>

        <!-- NEW: Auth buttons -->
        <div id="authArea">
          <button class="btn" id="openSignIn">
            <span class="avatar" aria-hidden="true"></span> Sign in
          </button>
          <button class="btn hidden" id="signOutBtn">Sign out</button>
        </div>
      </div>
    </header>

    <!-- Page head -->
    <section class="container page-head">
      <h1 class="page-title">Community Forum</h1>
      <p class="page-sub">
        Discuss books, themes, and legal perspectives. Be respectful and cite
        sources when appropriate.
      </p>

      <div class="tabs">
        <button class="tab active" data-sort="hot">Hot</button>
        <button class="tab" data-sort="new">New</button>
        <button class="tab" data-sort="top">Top</button>
        <div class="tools">
          <button class="btn ghost" id="openNewPost">New post</button>
        </div>
      </div>
      <div class="tagbar" id="tagbar">
        <button class="chip active" data-tag="All">All</button>
        <button class="chip" data-tag="Poetry">Poetry</button>
        <button class="chip" data-tag="Fiction">Fiction</button>
        <button class="chip" data-tag="Nonfiction">Nonfiction</button>
        <button class="chip" data-tag="Law & Ethics">Law & Ethics</button>
        <button class="chip" data-tag="Events">Events</button>
      </div>
    </section>

    <!-- Thread list -->
    <main class="container">
      <div id="threads" class="threads"></div>
    </main>

    <!-- Sign in / Sign up modal -->
    <div class="modal" id="authModal">
      <div class="sheet">
        <h3 id="authTitle">Sign in</h3>
        <p>Accounts are required to post or reply.</p>
        <div class="field">
          <label>Email</label
          ><input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>Password</label
          ><input id="password" type="password" placeholder="••••••••" />
        </div>
        <div class="field hidden" id="usernameField">
          <label>Username</label
          ><input id="username" placeholder="your-handle" />
        </div>
        <div class="row">
          <button class="btn primary" id="authPrimaryBtn">Sign in</button>
          <button class="btn ghost" id="authCancelBtn">Cancel</button>
        </div>
        <p class="page-sub" style="margin-top: 10px">
          <span id="authSwitchLine">No account?</span>
          <a class="link" href="#" id="authSwitch">Create one</a>
        </p>
        <p id="authError" class="page-sub" style="color: #b91c1c"></p>
      </div>
    </div>

    <!-- New Post modal -->
    <div class="modal" id="postModal">
      <div class="sheet">
        <h3>New post</h3>
        <div class="field">
          <label>Title</label
          ><input
            id="postTitle"
            maxlength="200"
            placeholder="What do you want to discuss?"
          />
        </div>
        <div class="field">
          <label>Body</label
          ><textarea
            id="postBody"
            rows="6"
            placeholder="Write your post... (optional)"
          ></textarea>
        </div>
        <div class="field">
          <label>Tags (comma-separated)</label
          ><input id="postTags" placeholder="Poetry, Law & Ethics" />
        </div>
        <div class="row">
          <button class="btn primary" id="createPostBtn">Publish</button>
          <button class="btn ghost" id="postCancelBtn">Cancel</button>
        </div>
        <p id="postError" class="page-sub" style="color: #b91c1c"></p>
      </div>
    </div>

    <footer
      class="container"
      style="
        border-top: 1px solid var(--rule);
        color: var(--muted);
        text-align: center;
        padding: 24px 0 46px;
        margin-top: 24px;
      "
    >
      © <span id="year"></span> A.I. Unlimited Publishing House LLC — All
      rights reserved.
    </footer>

    <!-- Supabase client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // show we're on the newest file
      console.log("community.js v5", new Date().toISOString());

      document.getElementById("year").textContent = new Date().getFullYear();

      // ========= CONFIG =========
      const SUPABASE_URL = "https://wmfqzxlzaipqdhohvulp.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZnF6eGx6YWlwcWRob2h2dWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzg1NDIsImV4cCI6MjA3MTc1NDU0Mn0.l_1y79L33k5Lm5oNKG8aT6emNTF79udKXUTQLqwf7Fo";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // ========= UI ELEMENTS =========
      const threadsEl = document.getElementById("threads");
      const authModal = document.getElementById("authModal");
      const postModal = document.getElementById("postModal");
      const openSignIn = document.getElementById("openSignIn");
      const signOutBtn = document.getElementById("signOutBtn");
      const authCancelBtn = document.getElementById("authCancelBtn");
      const authPrimaryBtn = document.getElementById("authPrimaryBtn");
      const authSwitch = document.getElementById("authSwitch");
      const authTitle = document.getElementById("authTitle");
      const authError = document.getElementById("authError");
      const usernameField = document.getElementById("usernameField");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const usernameInput = document.getElementById("username");
      const openNewPost = document.getElementById("openNewPost");
      const postCancelBtn = document.getElementById("postCancelBtn");
      const createPostBtn = document.getElementById("createPostBtn");
      const postTitle = document.getElementById("postTitle");
      const postBody = document.getElementById("postBody");
      const postTags = document.getElementById("postTags");

      const tabs = Array.from(document.querySelectorAll(".tab"));
      const chips = Array.from(document.querySelectorAll(".chip"));

      let mode = "signin";
      let currentSort = "hot";
      let currentTag = "All";
      let currentUser = null;

      // ========= HELPERS =========
      const open = (el) => el.classList.add("open");
      const close = (el) => el.classList.remove("open");
      const setHidden = (el, hidden) => el.classList.toggle("hidden", hidden);

      function formatTimeAgo(iso) {
        const seconds = Math.floor((Date.now() - new Date(iso)) / 1000);
        const intervals = [
          ["year", 31536000],
          ["month", 2592000],
          ["day", 86400],
          ["hour", 3600],
          ["minute", 60],
        ];
        for (const [label, secs] of intervals) {
          const v = Math.floor(seconds / secs);
          if (v >= 1) return `${v} ${label}${v > 1 ? "s" : ""} ago`;
        }
        return "just now";
      }

      function escapeHtml(s) {
        return (s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[c]
        );
      }

      function renderThreads(rows) {
        threadsEl.innerHTML = "";
        if (!rows || rows.length === 0) {
          threadsEl.innerHTML =
            '<p class="page-sub">No posts yet. Be the first!</p>';
          return;
        }
        for (const t of rows) {
          const tagBadges = (t.tags || [])
            .map((tag) => `<span class="tt">${tag}</span>`)
            .join("");
          const item = document.createElement("article");
          item.className = "thread";
          item.innerHTML = `
            <div class="vote" aria-label="votes" data-id="${t.id}">
              <span class="up" data-dir="up"></span>
              <span class="count">${t.score ?? 0}</span>
              <span class="down" data-dir="down"></span>
            </div>
            <div class="thread-main">
              <h3 class="thread-title"><a class="link" href="#">${escapeHtml(t.title)}</a></h3>
              <div class="thread-meta">Started by <strong>${t.author_id.slice(0, 8)}</strong> · ${t.comment_count} comments · ${formatTimeAgo(t.created_at)}</div>
              <div class="thread-tags">${tagBadges}</div>
            </div>
            <div class="thread-cta">
              <a class="link" href="#">Open thread →</a>
              <button class="btn sm primary">Reply</button>
            </div>`;
          item.querySelector(".vote").addEventListener("click", async (e) => {
            const dir = e.target?.dataset?.dir;
            if (!dir) return;
            if (!currentUser) {
              open(authModal);
              return;
            }
            const value = dir === "up" ? 1 : -1;
            await upsertVote(t.id, value);
            await loadThreads();
          });
          threadsEl.appendChild(item);
        }
      }

      // ========= DATA FETCH =========
      async function loadThreads() {
        console.log("loadThreads() start", { currentTag, currentSort });

        let q = supabase.from("threads_with_score").select("*");
        if (currentTag !== "All") q = q.contains("tags", [currentTag]);
        if (currentSort === "hot") {
          q = q
            .order("score", { ascending: false })
            .order("created_at", { ascending: false });
        } else if (currentSort === "new") {
          q = q.order("created_at", { ascending: false });
        } else if (currentSort === "top") {
          q = q.order("score", { ascending: false });
        }

        const { data, error } = await q.limit(50);
        if (error) {
          console.error("loadThreads error:", error);
          threadsEl.innerHTML = `
            <div style="padding:12px;border:1px solid #fecaca;background:#fee2e2;border-radius:10px;color:#991b1b">
              <strong>Could not load threads.</strong><br>
              <code>${error.message || JSON.stringify(error)}</code>
            </div>`;
          return;
        }
        console.log("loadThreads() got", data?.length || 0, "rows");
        renderThreads(data);
      }

      async function upsertVote(threadId, value) {
        const { error } = await supabase
          .from("votes")
          .upsert(
            { user_id: currentUser.id, thread_id: threadId, value },
            { onConflict: "user_id,thread_id" }
          );
        if (error) console.error(error);
      }

      async function createThread({ title, body, tags }) {
        const { data: profile } = await ensureProfile();
        const { error } = await supabase
          .from("threads")
          .insert({ title, body, tags, author_id: profile.id });
        if (error) throw error;
      }

      async function ensureProfile() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) return { data: null };
        const id = user.id;
        const { data: existing } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", id)
          .maybeSingle();
        if (existing) return { data: existing };
        const username =
          usernameInput.value?.trim() || `user_${id.slice(0, 8)}`;
        const { data, error } = await supabase
          .from("profiles")
          .insert({ id, username })
          .select("*")
          .single();
        if (error) console.error(error);
        return { data };
      }

      // ========= AUTH =========
      function setAuthedUI(on) {
        setHidden(openSignIn, on);
        setHidden(signOutBtn, !on);
      }

      function setAuthMode(next) {
        mode = next;
        authError.textContent = "";
        authTitle.textContent =
          next === "signin" ? "Sign in" : "Create account";
        authPrimaryBtn.textContent = next === "signin" ? "Sign in" : "Sign up";
        document.getElementById("authSwitchLine").textContent =
          next === "signin" ? "No account?" : "Already have an account?";
        authSwitch.textContent = next === "signin" ? "Create one" : "Sign in";
        setHidden(usernameField, next !== "signup");
      }

      openSignIn.addEventListener("click", () => {
        setAuthMode("signin");
        open(authModal);
      });

      // ======= ROBUST SIGN-OUT (global scope + debounce + cache-busting reload) =======
      let signingOut = false;
      signOutBtn.addEventListener("click", async () => {
        if (signingOut) return;
        signingOut = true;
        signOutBtn.disabled = true;
        console.log("Sign-out clicked");

        // Sign out across all tabs for this origin
        const { error } = await supabase.auth.signOut({ scope: "global" });
        if (error) {
          console.error("Sign out error:", error);
          alert("Could not sign out.");
          signOutBtn.disabled = false;
          signingOut = false;
          return;
        }

        // Force a clean reload (bust cache so newest script is loaded)
        const url = new URL(location.href);
        url.searchParams.set("signedout", Date.now());
        location.href = url.toString();
      });

      authCancelBtn.addEventListener("click", () => close(authModal));
      authSwitch.addEventListener("click", (e) => {
        e.preventDefault();
        setAuthMode(mode === "signin" ? "signup" : "signin");
      });

      authPrimaryBtn.addEventListener("click", async () => {
        authError.style.color = "#b91c1c";
        authError.textContent = "";

        const email = emailInput.value.trim();
        const password = passwordInput.value;

        try {
          if (mode === "signin") {
            const { error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });
            if (error) throw error;
            close(authModal);
          } else {
            const { data, error } = await supabase.auth.signUp({
              email,
              password,
            });
            if (error) throw error;
            if (data.session) {
              close(authModal);
            } else {
              authError.style.color = "#0f766e";
              authError.textContent =
                "Check your email to confirm your account, then sign in.";
            }
            await ensureProfile();
          }
        } catch (e) {
          authError.textContent = e.message || "Authentication failed.";
        }
      });

      // Keep UI in sync with session (also reset sign-out UI state after re-auth)
      supabase.auth.onAuthStateChange(async (evt, session) => {
        console.log("Auth change:", evt, !!session);
        currentUser = session?.user || null;
        setAuthedUI(!!currentUser);
        if (currentUser) await ensureProfile();
        await loadThreads();

        // Reset sign-out state whenever auth changes
        signingOut = false;
        signOutBtn.disabled = false;
      });

      // ========= NEW POST =========
      openNewPost.addEventListener("click", () => {
        if (!currentUser) {
          setAuthMode("signin");
          open(authModal);
          return;
        }
        postTitle.value = "";
        postBody.value = "";
        postTags.value = "";
        open(postModal);
      });
      postCancelBtn.addEventListener("click", () => close(postModal));
      createPostBtn.addEventListener("click", async () => {
        const title = postTitle.value.trim();
        const body = postBody.value.trim() || null;
        const tags = postTags.value
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        const postErr = document.getElementById("postError");
        postErr.textContent = "";
        if (!title) {
          postErr.textContent = "Title is required.";
          return;
        }
        try {
          await createThread({ title, body, tags });
          close(postModal);
          await loadThreads();
        } catch (e) {
          postErr.textContent = e.message || "Could not create post.";
        }
      });

      // ========= FILTERS =========
      tabs.forEach((tab) =>
        tab.addEventListener("click", async () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentSort = tab.dataset.sort;
          await loadThreads();
        })
      );

      chips.forEach((chip) =>
        chip.addEventListener("click", async () => {
          chips.forEach((c) => c.classList.remove("active"));
          chip.classList.add("active");
          currentTag = chip.dataset.tag;
          await loadThreads();
        })
      );

      // Close modals with Escape
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          close(authModal);
          close(postModal);
        }
      });

      // ========= INIT =========
      (async function init() {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        currentUser = session?.user || null;
        setAuthedUI(!!currentUser);
        await loadThreads();
      })();
    </script>
  </body>
</html>
