<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thread — Landlord Fortress</title>
    <link rel="stylesheet" href="https://use.typekit.net/kbs3miz.css" />
    <style>
      :root {
        --bg: #f7f9fc;
        --surface: #fff;
        --rule: #e8eef4;
        --text: #1f2937;
        --muted: #6b7280;
        --accent: #22c1a1;
        --radius: 12px;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "proxima-nova", system-ui, Arial;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .meta {
        color: var(--muted);
      }
      .box {
        background: var(--surface);
        border: 1px solid var(--rule);
        border-radius: var(--radius);
        padding: 14px;
      }
      .btn {
        appearance: none;
        border: 1px solid #d5dde7;
        background: #fff;
        padding: 10px 14px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.primary {
        background: var(--accent);
        border-color: transparent;
        color: #062a26;
      }
      textarea,
      input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d5dde7;
        border-radius: 10px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .error {
        color: #b91c1c;
      }
      .comment {
        display: grid;
        grid-template-columns: 8px 1fr;
        gap: 10px;
      }
      .bar {
        border-left: 2px solid #e2e8f0;
        border-radius: 2px;
      }
      .tt {
        font-size: 0.72rem;
        padding: 4px 8px;
        border: 1px solid var(--rule);
        border-radius: 999px;
        color: #64748b;
        margin-left: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <p><a class="meta" href="community.html">← Back to community</a></p>
      <h1 id="title">Loading…</h1>
      <p id="meta" class="meta"></p>
      <div id="body" class="box"></div>

      <h3 style="margin-top: 18px">Replies</h3>
      <div id="comments" class="box" style="display: grid; gap: 12px"></div>

      <h3 style="margin-top: 18px">Add a reply</h3>
      <div class="box" style="display: grid; gap: 8px">
        <textarea
          id="reply"
          rows="5"
          placeholder="Be constructive and cite sources."
        ></textarea>
        <div class="row">
          <button class="btn primary" id="send">Reply</button>
          <span id="err" class="error"></span>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://wmfqzxlzaipqdhohvulp.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZnF6eGx6YWlwcWRob2h2dWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzg1NDIsImV4cCI6MjA3MTc1NDU0Mn0.l_1y79L33k5Lm5oNKG8aT6emNTF79udKXUTQLqwf7Fo";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const esc = (s) =>
        (s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[c]
        );
      const ago = (iso) => {
        const s = Math.floor((Date.now() - new Date(iso)) / 1000);
        for (const [l, n] of [
          ["year", 31536000],
          ["month", 2592000],
          ["day", 86400],
          ["hour", 3600],
          ["minute", 60],
        ]) {
          const v = Math.floor(s / n);
          if (v >= 1) return `${v} ${l}${v > 1 ? "s" : ""} ago`;
        }
        return "just now";
      };

      const params = new URLSearchParams(location.search);
      const threadId = params.get("id");

      const titleEl = document.getElementById("title");
      const metaEl = document.getElementById("meta");
      const bodyEl = document.getElementById("body");
      const commentsEl = document.getElementById("comments");
      const replyEl = document.getElementById("reply");
      const sendBtn = document.getElementById("send");
      const errEl = document.getElementById("err");

      async function ensureProfile() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) return null;
        const { data: p } = await supabase
          .from("profiles")
          .select("id")
          .eq("id", user.id)
          .maybeSingle();
        if (!p) {
          await supabase
            .from("profiles")
            .insert({ id: user.id, username: `user_${user.id.slice(0, 8)}` });
        }
        return user;
      }

      async function loadThread() {
        const { data, error } = await supabase
          .from("threads_with_score")
          .select("*")
          .eq("id", threadId)
          .maybeSingle();

        if (error || !data) {
          titleEl.textContent = error?.message || "Not found";
          return;
        }

        // Fetch author username
        let authorName = `user_${data.author_id.slice(0, 8)}`;
        const { data: prof } = await supabase
          .from("profiles")
          .select("username")
          .eq("id", data.author_id)
          .maybeSingle();
        if (prof?.username) authorName = prof.username;

        titleEl.textContent = data.title;
        bodyEl.textContent = data.body || "";

        const tagBits = (data.tags || [])
          .map((t) => `<span class="tt">${esc(t)}</span>`)
          .join("");

        metaEl.innerHTML = `Posted by <strong>${esc(authorName)}</strong> · ${data.comment_count} comments · ${ago(data.created_at)}${tagBits ? " " + tagBits : ""}`;
      }

      async function loadComments() {
        commentsEl.innerHTML = "";

        const { data: rows, error } = await supabase
          .from("comments")
          .select("*")
          .eq("thread_id", threadId)
          .order("created_at", { ascending: true });

        if (error) {
          commentsEl.innerHTML = `<span class="error">${esc(error.message)}</span>`;
          return;
        }
        if (!rows || rows.length === 0) {
          commentsEl.textContent = "No replies yet.";
          return;
        }

        // Build a map author_id -> username
        const ids = [...new Set(rows.map((c) => c.author_id).filter(Boolean))];
        let nameById = new Map();
        if (ids.length) {
          const { data: profs } = await supabase
            .from("profiles")
            .select("id, username")
            .in("id", ids);
          nameById = new Map((profs || []).map((p) => [p.id, p.username]));
        }

        for (const c of rows) {
          const displayName =
            nameById.get(c.author_id) || `user_${c.author_id.slice(0, 8)}`;
          const row = document.createElement("div");
          row.className = "comment";
          row.innerHTML = `
            <div class="bar"></div>
            <div>
              <div class="meta"><strong>${esc(displayName)}</strong> · ${new Date(c.created_at).toLocaleString()}</div>
              <div style="white-space:pre-wrap">${esc(c.body)}</div>
            </div>`;
          commentsEl.appendChild(row);
        }
      }

      sendBtn.addEventListener("click", postReply);

      async function postReply() {
        errEl.textContent = "";
        const text = replyEl.value.trim();
        if (!text) {
          errEl.textContent = "Reply cannot be empty.";
          return;
        }

        const user = await ensureProfile();
        if (!user) {
          errEl.textContent = "Sign in on the Community page to reply.";
          return;
        }

        const { error } = await supabase
          .from("comments")
          .insert({ thread_id: threadId, body: text, author_id: user.id });

        if (error) {
          errEl.textContent = error.message;
          return;
        }

        replyEl.value = "";
        await loadThread(); // updates comment count
        await loadComments(); // renders with usernames
      }

      (async function init() {
        await loadThread();
        await loadComments();
      })();
    </script>
  </body>
</html>
